{% for link in linklists.[settings.linklist_nav].links %}

{% if collection.handle == blank %}
{% capture show_sub_nav %}no{% endcapture %}

{% elsif link.object.handle == collection.handle %}
{% capture show_sub_nav %}yes{% endcapture %}

{% endif %}
{% endfor %}
	
{% if show_sub_nav == 'yes' %}

<ul class="subnav clearfix">

	<li><a href="{{ collection.url }}">All</a></li>

	{% capture first_active_tag %}{{ product.tags | last}}{% endcapture %}
	{% capture second_active_tag %}{{ product.tags | first }}{% endcapture %}

	{% for tag in collection.all_tags %}

	{% if tag == first_active_tag or tag == second_active_tag %}

	<li class="active"><a href="{{ shop.url }}{{ collection.url}}/{{ tag | handleize }}">{{ tag }}</a></li>

	{% else %}
	
<li><a href="{{ shop.url }}{{ collection.url}}/{{ tag | handleize }}">{{ tag }}</a></li>

	{% endif %}

	{% endfor %}
</ul>

{% endif %}


<div class="product clearfix">

	<div class="product-images">
		<ul>
			{% for image in product.images %}
			{% if forloop.first %}
			<li>
				<a href="{{ image | product_img_url: 'grande' }}" rel="fancy" class="fancy_image" ><img src="{{ image | product_img_url: 'medium' }}"   /></a>
			</li>
			{% else %}
			<li><a href="{{ image | product_img_url: 'grande' }}" rel="fancy" class="fancy_image" ><img  src="{{ image | product_img_url: 'compact' }}" alt="{{ product.title | escape }}" width="110px" /></a></li>
			{% endif %}
			{% endfor %}
		</ul>

	</div><!-- .product-images -->

	<div class="product-details ">
		
		
    <div class="product-title clearfix">

      <h1>{{ product.title | escape }}</h1>

      {% if settings.show_product_social %}
      <ul class="product-social-buttons">
        <li><a href="http://twitter.com/share" class="twitter-share-button" data-text="Check out {{ product.handle }}" data-count="none">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script></li>
        <li><script src="http://connect.facebook.net/en_US/all.js#xfbml=1"></script><fb:like href="{{ shop.url }}/products/{{ product.handle }}" layout="button_count" show_faces="true" width="150"></fb:like></li>

      </ul>
      {% endif %}

    </div><!-- .product-title -->


		<div class="description">
			{{ product.description }}   
		</div><!-- .description -->


    {% if product.available %}
      <form action="/cart/add" method="post" class="variants" id="product-actions">
        <div class="options clearfix">  

          <div class="variants-wrapper clearfix {% if product.variants.size == 1 %}visuallyhidden{% endif %}"> 
            <select id="product-select" name="id">
              {% for variant in product.variants %}
              <option value="{{ variant.id }}">{{ variant.title | escape }} - {{ variant.price | money }}</option>
              {% endfor %}
            </select>
          </div>            
            
          <div id="purchase">
            <p class="price"></p>                                 
            <input class="btn" type="submit" name="add" id="add-to-cart" value="Add to Cart" />
          </div>

        </div><!-- /.options -->
      </form>

    {% else %}
      <div id="product-actions" class="sold-out">
        <div id="purchase">
          <p class="price">Sold out.</p>      
        </div>
      </div>      
    {% endif %}
  </div><!-- /#product-header -->
        

</div><!-- /#product-information -->


		</div><!-- .product-details-->
	</div><!-- .product -->


		
		
		{% if collection.handle != blank %}
		
    <div class="related-products">

      <div class="extra-border clearfix">
        <h2>Related Products</h2>
      </div><!-- .extra-border -->


      <table class="products five">

        {% capture current_product %}{{product.handle}}{% endcapture %}

        <tr>
          {% for product in collection.products limit:5%}
          {% if product.handle == current_product %}
          {% for product in collection.products limit:6 %}
          {% unless product.handle == current_product %}
          {% if forloop.last and forloop.length > 4 %}
          <td>
            <a href="{{ product.url | within: collection }}"><span><img src="{{ product.images.first | product_img_url: 'compact' }}"  alt="{{ product.title | escape }}" /></span>{% if product.compare_at_price_max > product.price %}<em>sale</em>{% endif %}<strong>{{ product.title }}</strong><small>{{ product.price  | money }}</small></a>
          </td>
          {% endif %}
          {% endunless %}
          {% endfor %}
          {% else %}

          <td>
            <a href="{{ product.url | within: collection }}"><span><span class="vertical-center"><img src="{{ product.images.first | product_img_url: 'compact' }}"  alt="{{ product.title | escape }}" /></span></span>{% if product.compare_at_price_max > product.price %}<em>sale</em>{% endif %}<strong>{{ product.title }}</strong><small>{{ product.price  | money }}</small></a>
          </td>

          {% endif %}
          {% endfor %}



        </tr>
      </table>
    </div><!-- .related-products -->
	
			{% endif %}
	
	
	
	    {%if product.available %}
      <script>
        var selectCallback = function(variant, selector) {
          if (variant && variant.available) {
            // selected a valid variant
            $('#add-to-cart').removeClass('disabled').removeAttr('disabled'); // remove unavailable class from add-to-cart button, and re-enable button
            
            if(variant.compare_at_price == null){
              $('.options .price').html('<strong>'+Shopify.formatMoney(variant.price, "{{shop.money_with_currency_format}}")+'</strong>');
            } else {
              $('.options .price').html('<strong>'+Shopify.formatMoney(variant.price, "{{shop.money_with_currency_format}}") + '</strong> <span class="compare_at_price">was <del>' + Shopify.formatMoney(variant.compare_at_price, "{{shop.money_with_currency_format}}") + '</del></span>');
            }
          } else {
            // variant doesn't exist
            $('#add-to-cart').addClass('disabled').attr('disabled', 'disabled'); // set add-to-cart button to unavailable class and disable button
            var message = variant ? "Sold Out" : "Unavailable";    
            $('.options .price').text(message); // update price-field message
          }
        };

        // initialize multi selector for product
        $(function() {
          new Shopify.OptionSelectors("product-select", { product: {{ product | json }}, onVariantSelected: selectCallback });
          {% assign found_one_in_stock = false %}

          {% for variant in product.variants %}
            {% if variant.available and found_one_in_stock == false %}
              {% assign found_one_in_stock = true %}
              {% for option in product.options %}
              $('.single-option-selector:eq(' + {{ forloop.index0 }} + ')').val({{ variant.options[forloop.index0] | json }}).trigger('change');
              {% endfor %}
            {% endif %}
          {% endfor %}  
        });
      </script>
      {% endif %}

